version: "3.3"
services:
    todo-server:
        environment:
            CONFIGURATION_FILEPATH: '/etc/config.toml'
            JAEGER_AGENT_HOST: 'tracing-server'
            JAEGER_AGENT_PORT: '6831'
            JAEGER_SAMPLER_MANAGER_HOST_PORT: 'tracing-server:5778'
            JAEGER_SERVICE_NAME: 'todo-server'
        ports:
            - 80:8888
#        links:
#            - tracing-server
#            - prometheus
#            - loki
#            - promtail
        build:
            context: '../../../../'
            dockerfile: 'environments/testing/dockerfiles/integration-server.Dockerfile'
    test:
        environment:
            TARGET_ADDRESS: 'http://todo-server:8888'
        links:
            - todo-server
        build:
            context: '../../../../'
            dockerfile: 'environments/testing/dockerfiles/integration-tests.Dockerfile'
        container_name: 'integration_tests'
#    tracing-server:
#        image: jaegertracing/all-in-one:latest
#        logging:
#            driver: none
#        ports:
#            - 6831:6831
#            - 5778:5778
#            - 16686:16686
#    prometheus:
#        image: quay.io/prometheus/prometheus:v2.0.0
#        logging:
#            driver: none
#        ports:
#            - 9090:9090
#        volumes:
#            - source: "../../../../environments/testing/prometheus/config.yaml"
#              target: "/etc/prometheus/config.yaml"
#              type: 'bind'
#        command: '--config.file=/etc/prometheus/config.yaml --storage.tsdb.path=/prometheus'
#    loki:
#        image: grafana/loki:1.6.0
#        ports:
#            - "3100:3100"
#        command: -config.file=/etc/loki/local-config.yaml
#        logging:
#            driver: none
#        volumes:
#            - source: '../../../../environments/testing/loki/config.yaml'
#              target: '/etc/loki/local-config.yaml'
#              type: 'bind'
#        links:
#            - grafana
#    promtail:
#        image: grafana/promtail:1.6.0
#        command: -config.file=/etc/promtail/config.yaml
#        volumes:
#            - /var/log:/var/log
#            - source: '../../../../environments/testing/promtail/config.yaml'
#              target: '/etc/promtail/config.yaml'
#              type: 'bind'
#        logging:
#            driver: none
#        links:
#            - loki
#    grafana:
#        image: grafana/grafana
#        logging:
#            driver: none
#        ports:
#            - 3000:3000
#        links:
#            - prometheus
#        volumes:
#            - source: '../../../../environments/testing/grafana/grafana.ini'
#              target: '/etc/grafana/grafana.ini'
#              type: 'bind'
#            - source: '../../../../environments/testing/grafana/datasources.yaml'
#              target: '/etc/grafana/provisioning/datasources/datasources.yml'
#              type: 'bind'
#            - source: '../../../../environments/testing/grafana/dashboards.yaml'
#              target: '/etc/grafana/provisioning/dashboards/dashboards.yml'
#              type: 'bind'
#            - source: '../../../../environments/testing/grafana/dashboards'
#              target: '/etc/grafana/provisioning/dashboards/dashboards'
#              type: 'bind'

stages:
    - testing
    - deliver

image: docker:latest

services:
    - docker:dind

before_script:
    - mkdir -p /go/src/gitlab.com/verygoodsoftwarenotvirus/
    - cp -rf /builds/verygoodsoftwarenotvirus/newsman
      /go/src/gitlab.com/verygoodsoftwarenotvirus/
    - cd /go/src/gitlab.com/verygoodsoftwarenotvirus/newsman
    - apk add --update --no-cache make git gcc musl-dev

unit-tests:
    stage: testing
    image: golang:alpine
    variables:
        GO111MODULES: 'on'
        GOPATH: '/go'
    script:
        - make vendor test

deliver:
    stage: deliver
    image:
        name: registry.gitlab.com/hyper-expanse/open-source/semantic-delivery-gitlab:9.0.0
        entrypoint: ['']
    only:
        - master
    script:
        - semantic-delivery-gitlab  --token $GITLAB_TOKEN
